### Mage Ovale script based on SimulationCraft profiles
### https://sites.google.com/site/wownerien/ovale/mage/script
### Version: 4.3.22
#
# Arcane:
#	talents=http://www.wowhead.com/talent#mage-3033220212301002121212300200000000000000000300000000000000000
#	glyphs=arcane_blast/arcane_missiles/mage_armor/arcane_power/evocation/slow/arcane_brilliance/conjuring/mirror_image
#
# Fire:
#	talents=http://www.wowhead.com/talent#mage-3030100000000000000002313302201201210130310300000000000000000
#	glyphs=fireball/pyroblast/molten_armor/evocation/dragons_breath/mana_shield/conjuring/arcane_brilliance/slow_fall
#
# Frost:
#	talents=http://www.wowhead.com/talent#mage-0020000000000000000002303000000000000000002323021013331301021
#	glyphs=frostbolt/frostfire/deep_freeze/evocation/ice_barrier/blink/arcane_brilliance/conjuring/slow_fall

## defines ##

# Buffs
Define(ARCANEBLASTDEBUFF 36032)
Define(ARCANEMISSILEBUFF 79683)
Define(BRAINFREEZE 57761)
Define(CLEARCASTING 12536)
Define(FINGERSOFFROST 44544)
	SpellInfo(FINGERSOFFROST duration=14)
Define(HOTSTREAK 48108)
Define(IMPROVEDMANAGEM 83098)
SpellList(MAGEBUFF 79057 79039) # Arcane/Dalaran Brilliance
Define(PRESENCEOFMIND 12043)
Define(STOLENTIME 105785) # 2pT13 buff stacks up to 10 times

# Debuffs
Define(COMBUSTIONDEBUFF 83853)
Define(CRITICALMASS 22959)
Define(IGNITE 12654)

# Glyphs
Define(GLYPHOFFROSTBOLT 56370)
Define(GLYPHOFFROSTFIRE 61205)

# Talents
Define(ARCANEPOWERTALENT 9186)
Define(COLDSNAPTALENT 9870)
Define(CRITICALMASSTALENT 10541)
Define(DEEPFREEZETALENT 9898)
Define(FIRESTARTERTALENT 11431)
Define(ICEFLOESTALENT 9846)
Define(ICYVEINSTALENT 9858)
Define(IMPROVEDSCORCHTALENT 10547)
Define(PRESENCEOFMINDTALENT 9174)

# Spells
Define(ARCANEBARRAGE 44425)
	SpellInfo(ARCANEBARRAGE cd=4)
	SpellAddDebuff(ARCANEBARRAGE ARCANEBLASTDEBUFF=0)
Define(ARCANEBLAST 30451)
	SpellAddDebuff(ARCANEBLAST ARCANEBLASTDEBUFF=10)
Define(ARCANEBRILLIANCE 1459)
Define(ARCANEMISSILES 5143)
	SpellAddDebuff(ARCANEMISSILES ARCANEBLASTDEBUFF=0 ARCANEMISSILEBUFF=0)
Define(ARCANEPOWER 12042)
	SpellInfo(ARCANEPOWER cd=84)
	SpellAddBuff(ARCANEPOWER ARCANEPOWER=15)
Define(COLDSNAP 11958)
	SpellInfo(COLDSNAP cd=384)
Define(COMBUSTION 11129)
	SpellInfo(COMBUSTION cd=120 duration=10 tick=1)
	SpellAddDebuff(COMBUSTION COMBUSTIONDEBUFF=10)
Define(CONJUREMANAGEM 759)
	SpellInfo(CONJUREMANAGEM cd=10) #fake
Define(COUNTERSPELL 2139)
	SpellInfo(COUNTERSPELL cd=24)
Define(DEEPFREEZE 44572)
	SpellInfo(DEEPFREEZE cd=30)
	SpellAddBuff(DEEPFREEZE FINGERSOFFROST=-1)
Define(EVOCATION 12051)
	SpellInfo(EVOCATION cd=240)
Define(FIREBALL 133)
Define(FIREBLAST 2136)
	SpellInfo(FIREBLAST cd=8)
Define(FLAMEORB 82731)
	SpellInfo(FLAMEORB cd=60)
Define(FROSTARMOR 7302)
	SpellAddBuff(FROSTARMOR FROSTARMOR=1800)
Define(FROSTBOLT 116)
Define(FROSTFIREBOLT 44614)
	SpellAddTargetDebuff(FROSTFIREBOLT FROSTFIREBOLT=9)
	SpellAddBuff(FROSTFIREBOLT BRAINFREEZE=-1 FINGERSOFFROST=-1)
Define(ICELANCE 30455)
	SpellAddBuff(ICELANCE FINGERSOFFROST=-1)
Define(ICYVEINS 12472)
	SpellInfo(ICYVEINS cd=144)
Define(LIVINGBOMB 44457)
	SpellInfo(LIVINGBOMB duration=12 tick=3)
	SpellAddTargetDebuff(LIVINGBOMB LIVINGBOMB=12)
Define(MAGEARMOR 6117)
	SpellAddBuff(MAGEARMOR MAGEARMOR=1800)
Define(MIRRORIMAGE 55342)
	SpellInfo(MIRRORIMAGE cd=180)
Define(MOLTENARMOR 30482)
	SpellAddBuff(MOLTENARMOR MOLTENARMOR=1800)
Define(PYROBLAST 11366)
	SpellInfo(PYROBLAST duration=12 tick=3)
	SpellAddTargetDebuff(PYROBLAST PYROBLAST=12)
	SpellAddBuff(PYROBLAST HOTSTREAK=0)
Define(PYROBLASTBANG 92315)
	SpellInfo(PYROBLASTBANG duration=12 tick=3)
	SpellAddTargetDebuff(PYROBLASTBANG PYROBLASTBANG=12)
	SpellAddBuff(PYROBLASTBANG HOTSTREAK=0)
Define(SCORCH 2948)
	SpellInfo(SCORCH duration=30 talent=CRITICALMASSTALENT)
Define(SPELLSTEAL 30449)
Define(SUMMONWATERELEMENTAL 31687)
	SpellInfo(SUMMONWATERELEMENTAL cd=180)

Define(PETFREEZE 33395)
	SpellInfo(PETFREEZE cd=25)
	SpellAddBuff(PETFREEZE FINGERSOFFROST=2)

# Racials & Professions
Define(ARCANETORRENTMANA 28730) # blood elf
	SpellInfo(ARCANETORRENTMANA sharedcd=racial cd=120)
Define(BERSERKING 26297) # troll
	SpellInfo(BERSERKING duration=10 cd=180)
	SpellAddBuff(BERSERKING BERSERKING=10)
Define(BLOODFURY 33697) # orc
	SpellInfo(BLOODFURY duration=15 cd=120)
	SpellAddBuff(BLOODFURY BLOODFURY=15)
Define(LIFEBLOOD 55503) # herbalism
	SpellInfo(LIFEBLOOD duration=20 cd=120)
Define(STONEFORM 20594) # dwarf
	SpellInfo(STONEFORM duration=8 cd=120)
	SpellAddBuff(STONEFORM STONEFORM=8)

# Items
Define(MANAGEMITEM 36799)
Define(VOLCANICPOTION 58091)
	Define(VOLCANICPOTIONSPELL 80481)

## end defines ##

ScoreSpells(SCORCH PYROBLAST LIVINGBOMB FROSTFIREBOLT FIREBALL SUMMONWATERELEMENTAL PETFREEZE FROSTBOLT ARCANEBLAST ARCANEMISSILES ARCANEBARRAGE
			DEEPFREEZE ICELANCE)

AddCheckBox(potions SpellName(VOLCANICPOTIONSPELL) default)
AddCheckBox(mirrorimage SpellName(MIRRORIMAGE) default)
AddCheckBox(stolentime SpellName(STOLENTIME) mastery=2)

# Trinket CDs
AddListItem(trinketcd0 000 "Trinket 0 CD - none" default)
AddListItem(trinketcd0 060 "Trinket 0 CD - 1 min")
AddListItem(trinketcd0 090 "Trinket 0 CD - 1 min 30s")
AddListItem(trinketcd0 120 "Trinket 0 CD - 2 min")
AddListItem(trinketcd1 000 "Trinket 1 CD - none" default)
AddListItem(trinketcd1 060 "Trinket 1 CD - 1 min")
AddListItem(trinketcd1 090 "Trinket 1 CD - 1 min 30s")
AddListItem(trinketcd1 120 "Trinket 1 CD - 2 min")

# Separate out the full Arcane rotation into "burn" (DPS) rotation and "hover" (DPM)
# rotation to allow the player to choose when to enter each part of the rotation.
# Show a +/- icon between the two rotations to show which rotation is optimal, with
# "+" meaning use the burn (left) rotation, and "-" meaning to use the hover (right)
# rotation.
AddCheckBox(separate "Separate DPS/DPM rotations" mastery=1)

AddFunction UseItemActions
{
	Item(HandsSlot usable=1)
	unless List(trinketcd0 000) Item(Trinket0Slot usable=1)
	unless List(trinketcd1 000) Item(Trinket1Slot usable=1)
}

AddFunction UseProfessionActions
{
	Spell(LIFEBLOOD)
}

###
### Arcane
###

# Arcane DPS rotation for maximum burst damage.
AddFunction ArcaneDPS
{
	unless InCombat()
	{
		if BuffExpires(MAGEBUFF 400) Spell(ARCANEBRILLIANCE)
		if BuffExpires(MAGEARMOR 400) and BuffExpires(FROSTARMOR 400) Spell(MAGEARMOR)
	}

	#/arcane_brilliance
	unless BuffPresent(MAGEBUFF) Spell(ARCANEBRILLIANCE)
	#/mage_armor
	unless BuffPresent(MAGEARMOR) or BuffPresent(FROSTARMOR) Spell(MAGEARMOR)
	#/conjure_mana_gem,invulnerable=1,if=mana_gem_charges<3
	unless InCombat() if ItemCount(MANAGEMITEM less 3 charges=1) Spell(CONJUREMANAGEM)

	#/evocation,if=((max_mana>max_mana_nonproc&mana_pct_nonproc<=40)|(max_mana=max_mana_nonproc&mana_pct<=35))&target.time_to_die>10
	if ManaPercent(less 35) and TargetDeadIn(more 10) Spell(EVOCATION)
	#if ( ! talents.presence_of_mind -> rank() )
	#	{ /conjure_mana_gem,if=cooldown.evocation.remains<20&target.time_to_die>105&mana_gem_charges=0 }
	if TalentPoints(PRESENCEOFMINDTALENT equal 0)
		if 20s before Spell(EVOCATION) and TargetDeadIn(more 105) and ItemCount(MANAGEMITEM equal 0 charges=1)
			Spell(CONJUREMANAGEM)
	#/arcane_torrent,if=mana_pct<91&(buff.arcane_power.up|target.time_to_die<120)
	if ManaPercent(less 91) and {BuffPresent(ARCANEPOWER) or TargetDeadIn(less 120)} Spell(ARCANETORRENTMANA)
	#if ( set_bonus.tier13_4pc_caster() )
	#	/mana_gem,if=buff.arcane_blast.stack=4&buff.tier13_2pc.stack>=7&(cooldown.arcane_power.remains<=0|target.time_to_die<=50)
	#else
	#	/mana_gem,if=buff.arcane_blast.stack=4
	if ArmorSetParts(T13 more 3) and DebuffPresent(ARCANEBLASTDEBUFF stacks=4)
		if BuffPresent(STOLENTIME stacks=7) and Spell(ARCANEPOWER) and TargetDeadIn(less 50)
			Item(MANAGEMITEM)
	unless ArmorSetParts(T13 more 3) if DebuffPresent(ARCANEBLASTDEBUFF stacks=4) Item(MANAGEMITEM)
	#/conjure_mana_gem,if=buff.presence_of_mind.up&target.time_to_die>cooldown.mana_gem.remains&mana_gem_charges=0
	if BuffPresent(PRESENCEOFMIND) and {target.timeToDie() > item(MANAGEMITEM)} and ItemCount(MANAGEMITEM equal 0 charges=1) Spell(CONJUREMANAGEM)
	if Speed(more 0)
	{
		#/arcane_barrage,moving=1
		Spell(ARCANEBARRAGE)
		#/fire_blast,moving=1
		Spell(FIREBLAST)
		#/ice_lance,moving=1
		Spell(ICELANCE)
	}
	#/arcane_blast,if=buff.presence_of_mind.up
	if BuffPresent(PRESENCEOFMIND) Spell(ARCANEBLAST)
	#/arcane_blast,if=dps=1
	Spell(ARCANEBLAST)
}

# Arcane DPM rotation for mana-efficient damage by keeping mana level high
# to make use of mastery.
AddFunction ArcaneDPM
{
	unless InCombat()
	{
		if BuffExpires(MAGEBUFF 400) Spell(ARCANEBRILLIANCE)
		if BuffExpires(MAGEARMOR 400) and BuffExpires(FROSTARMOR 400) Spell(MAGEARMOR)
	}

	#/arcane_brilliance
	unless BuffPresent(MAGEBUFF) Spell(ARCANEBRILLIANCE)
	#/mage_armor
	unless BuffPresent(MAGEARMOR) or BuffPresent(FROSTARMOR) Spell(MAGEARMOR)
	#/conjure_mana_gem,invulnerable=1,if=mana_gem_charges<3
	unless InCombat() if ItemCount(MANAGEMITEM less 3 charges=1) Spell(CONJUREMANAGEM)

	#/evocation,if=((max_mana>max_mana_nonproc&mana_pct_nonproc<=40)|(max_mana=max_mana_nonproc&mana_pct<=35))&target.time_to_die>10
	if ManaPercent(less 35) and TargetDeadIn(more 10) Spell(EVOCATION)
	#if ( ! talents.presence_of_mind -> rank() )
	#	{ /conjure_mana_gem,if=cooldown.evocation.remains<20&target.time_to_die>105&mana_gem_charges=0 }
	if TalentPoints(PRESENCEOFMINDTALENT equal 0)
		if 20s before Spell(EVOCATION) and TargetDeadIn(more 105) and ItemCount(MANAGEMITEM equal 0 charges=1)
			Spell(CONJUREMANAGEM)
	#/arcane_torrent,if=mana_pct<91&(buff.arcane_power.up|target.time_to_die<120)
	if ManaPercent(less 91) and {BuffPresent(ARCANEPOWER) or TargetDeadIn(less 120)} Spell(ARCANETORRENTMANA)
	#if ( set_bonus.tier13_4pc_caster() )
	#	/mana_gem,if=buff.arcane_blast.stack=4&buff.tier13_2pc.stack>=7&(cooldown.arcane_power.remains<=0|target.time_to_die<=50)
	#else
	#	/mana_gem,if=buff.arcane_blast.stack=4
	if ArmorSetParts(T13 more 3) and DebuffPresent(ARCANEBLASTDEBUFF stacks=4)
		if BuffPresent(STOLENTIME stacks=7) and Spell(ARCANEPOWER) and TargetDeadIn(less 50)
			Spell(MANAGEMITEM)
	unless ArmorSetParts(T13 more 3) if DebuffPresent(ARCANEBLASTDEBUFF stacks=4) Item(MANAGEMITEM)
	#/conjure_mana_gem,if=buff.presence_of_mind.up&target.time_to_die>cooldown.mana_gem.remains&mana_gem_charges=0
	if BuffPresent(PRESENCEOFMIND) and {target.timeToDie() > item(MANAGEMITEM)} and ItemCount(MANAGEMITEM equal 0 charges=1)
		Spell(CONJUREMANAGEM)
	if Speed(more 0)
	{
		#/arcane_barrage,moving=1
		Spell(ARCANEBARRAGE)
		#/fire_blast,moving=1
		Spell(FIREBLAST)
		#/ice_lance,moving=1
		Spell(ICELANCE)
	}
	#/arcane_blast,if=buff.presence_of_mind.up
	if BuffPresent(PRESENCEOFMIND) Spell(ARCANEBLAST)
	#if ( set_bonus.tier13_4pc_caster() )
	#	/arcane_blast,if=target.time_to_die<20|\
	#		((cooldown.evocation.remains<=20|buff.improved_mana_gem.up|cooldown.mana_gem.remains<5)&mana_pct>=22)|\
	#		(buff.arcane_power.up&mana_pct_nonproc>88)
	#else
	#	/arcane_blast,if=target.time_to_die<20|\
	#		((cooldown.evocation.remains<=20|buff.improved_mana_gem.up|cooldown.mana_gem.remains<5)&mana_pct>=22)
	if TargetDeadIn(less 20) Spell(ARCANEBLAST)
	if {20s before Spell(EVOCATION) or BuffPresent(IMPROVEDMANAGEM) or 5s before Item(MANAGEMITEM)} and ManaPercent(more 22)
	{
		if ArmorSetParts(T13 more 3) and BuffPresent(ARCANEPOWER) and ManaPercent(more 88) Spell(ARCANEBLAST)
		unless ArmorSetParts(T13 more 3) Spell(ARCANEBLAST)
	}
	#/arcane_blast,if=buff.arcane_blast.remains<0.8&buff.arcane_blast.stack=4
	unless Speed(more 0) if DebuffExpires(ARCANEBLASTDEBUFF 0.8 stacks=4) Spell(ARCANEBLAST)
	#/arcane_missiles,if=mana_pct_nonproc<92&buff.arcane_missiles.react&mage_armor_timer<=2
	#/arcane_missiles,if=mana_pct_nonproc<93&buff.arcane_missiles.react&mage_armor_timer>2
	if ManaPercent(less 93) and BuffPresent(ARCANEMISSILEBUFF) Spell(ARCANEMISSILES)
	#/arcane_barrage,if=mana_pct_nonproc<87&buff.arcane_blast.stack=2
	if ManaPercent(less 87) and DebuffPresent(ARCANEBLASTDEBUFF stacks=2) unless DebuffPresent(ARCANEBLASTDEBUFF stacks=3) Spell(ARCANEBARRAGE)
	#/arcane_barrage,if=mana_pct_nonproc<90&buff.arcane_blast.stack=3
	if ManaPercent(less 90) and DebuffPresent(ARCANEBLASTDEBUFF stacks=3) unless DebuffPresent(ARCANEBLASTDEBUFF stacks=4) Spell(ARCANEBARRAGE)
	#/arcane_barrage,if=mana_pct_nonproc<92&buff.arcane_blast.stack=4
	if ManaPercent(less 92) and DebuffPresent(ARCANEBLASTDEBUFF stacks=4) Spell(ARCANEBARRAGE)
	#/arcane_blast
	Spell(ARCANEBLAST)
}

# Complete Arcane spell rotation.
AddIcon help=main mastery=1 checkboxoff=separate
{
	#/choose_rotation,cooldown=1,force_dps=1,if=buff.improved_mana_gem.up&dpm=1&\
	#    cooldown.evocation.remains+15<target.time_to_die
	if BuffPresent(IMPROVEDMANAGEM) and {spell(EVOCATION) + 15 < target.timeToDie()}
		ArcaneDPS()

	#/choose_rotation,cooldown=1,force_dpm=1,if=cooldown.evocation.remains<=20&dps=1&mana_pct<22&\
	#    (target.time_to_die>60|burn_mps*((target.time_to_die-5)-cooldown.evocation.remains)>max_mana_nonproc)&\
	#    cooldown.evocation.remains+15<target.time_to_die
	if 20s before Spell(EVOCATION) and ManaPercent(less 22)
		and {TargetDeadIn(more 60) or {spell(EVOCATION) > player.manaPercent()}}
		and {spell(EVOCATION) + 15 < target.timeToDie()}
		ArcaneDPM()

	#/choose_rotation,cooldown=1,evocation_pct=35,if=cooldown.evocation.remains+15>target.time_to_die,final_burn_offset=15
	if 20s before Spell(EVOCATION) and ManaPercent(more 35)
		ArcaneDPS()

	ArcaneDPM()
}

# Separate DPS "burn" rotation
AddIcon help=main mastery=1 checkboxon=separate
{
	ArcaneDPS()
}

# Copy of the complete Arcane spell rotation but with textures instead of functions.
# "+" is for DPS rotation: Texture(Spell_chargepositive)
# "-" is for DPM rotation: Texture(Spell_chargenegative)
AddIcon mastery=1 checkboxon=separate
{
	#/choose_rotation,cooldown=1,force_dps=1,if=buff.improved_mana_gem.up&dpm=1&\
	#    cooldown.evocation.remains+15<target.time_to_die
	if BuffPresent(IMPROVEDMANAGEM) and {spell(EVOCATION) + 15 < target.timeToDie()}
		Texture(Spell_chargepositive)

	#/choose_rotation,cooldown=1,force_dpm=1,if=cooldown.evocation.remains<=20&dps=1&mana_pct<22&\
	#    (target.time_to_die>60|burn_mps*((target.time_to_die-5)-cooldown.evocation.remains)>max_mana_nonproc)&\
	#    cooldown.evocation.remains+15<target.time_to_die
	if 20s before Spell(EVOCATION) and ManaPercent(less 22)
		and {TargetDeadIn(more 60) or {spell(EVOCATION) > player.manaPercent()}}
		and {spell(EVOCATION) + 15 < target.timeToDie()}
		Texture(Spell_chargenegative)

	#/choose_rotation,cooldown=1,evocation_pct=35,if=cooldown.evocation.remains+15>target.time_to_die,final_burn_offset=15
	if 20s before Spell(EVOCATION) and ManaPercent(more 35)
		Texture(Spell_chargepositive)

	Texture(Spell_chargenegative)
}

# Separate DPM "hover" rotation
AddIcon help=main mastery=1 checkboxon=separate
{
	ArcaneDPM()
}

AddIcon help=cd mastery=1
{
	#/volcanic_potion,if=!in_combat
	if CheckBoxOn(potions) unless InCombat() Item(VOLCANICPOTION)
	if TargetBuffStealable() Spell(SPELLSTEAL)
	#/counterspell
	if TargetIsInterruptible() Spell(COUNTERSPELL)
	#/use_item,if=buff.improved_mana_gem.up|cooldown.evocation.remains>90|target.time_to_die<=50
	if BuffPresent(IMPROVEDMANAGEM) or TargetDeadIn(less 50) UseItemActions()
	unless 90s before Spell(EVOCATION) UseItemActions()
	#init_use_profession_actions()
	UseProfessionActions()
	#/volcanic_potion,if=buff.improved_mana_gem.up|target.time_to_die<=50
	if CheckBoxOn(potions) and {BuffPresent(IMPROVEDMANAGEM) or TargetDeadIn(less 51)} Item(VOLCANICPOTION)
	#/use_item,name=shard_of_woe,if=buff.improved_mana_gem.up|cooldown.evocation.remains>90|target.time_to_die<=50
	#if BuffPresent(IMPROVEDMANAGEM) or {spell(EVOCATION) > 90} or TargetDeadIn(less 51) Item(SHARDOFWOE)
	#/flame_orb,if=target.time_to_die>=10
	if TargetDeadIn(more 9) Spell(FLAMEORB)
	#/blood_fury,if=buff.improved_mana_gem.up|target.time_to_die<=50
	if BuffPresent(IMPROVEDMANAGEM) or TargetDeadIn(less 50) Spell(BLOODFURY)
	#/berserking,if=buff.arcane_power.up|cooldown.arcane_power.remains>20
	if BuffPresent(ARCANEPOWER) Spell(BERSERKING)
	unless 20s before Spell(ARCANEPOWER) Spell(BERSERKING)
	#if ( talents.arcane_power -> rank() )
	#	if ( set_bonus.tier13_4pc_caster() )
	#		/arcane_power,if=(buff.improved_mana_gem.up&buff.tier13_2pc.stack>=9)|\
	#			(buff.tier13_2pc.stack>=10&cooldown.mana_gem.remains>30&cooldown.evocation.remains>10)|\
	#			target.time_to_die<=50
	#	else
	#		/arcane_power,if=buff.improved_mana_gem.up|target.time_to_die<=50
	#	/mirror_image,if=buff.arcane_power.up|(cooldown.arcane_power.remains>20&target.time_to_die>15)
	#else
	#	/mirror_image
	if TalentPoints(ARCANEPOWERTALENT more 0)
	{
		if TargetDeadIn(less 51) Spell(ARCANEPOWER)
		if TalentPoints(ARCANEPOWERTALENT more 0)
		{
			if BuffPresent(IMPROVEDMANAGEM) and BuffPresent(STOLENTIME stacks=9) Spell(ARCANEPOWER)
			if BuffPresent(STOLENTIME stacks=10)
				unless 30s before Item(MANAGEMITEM) or 10s before Spell(EVOCATION) Spell(ARCANEPOWER)
		}
		unless TalentPoints(ARCANEPOWERTALENT more 0) if BuffPresent(IMPROVEDMANAGEM) Spell(ARCANEPOWER)
		if CheckBoxOn(mirrorimage)
		{
			if BuffPresent(ARCANEPOWER) Spell(MIRRORIMAGE)
			unless 20s before Spell(ARCANEPPOWER) or TargetDeadIn(less 15) Spell(MIRRORIMAGE)
		}
	}
	unless TalentPoints(ARCANEPOWERTALENT more 0)
		if CheckBoxOn(mirrorimage) Spell(MIRRORIMAGE)
	#/presence_of_mind
	Spell(PRESENCEOFMIND)
}

###
### Fire
###
AddIcon help=main mastery=2
{
	unless InCombat() if BuffExpires(MAGEBUFF 400) Spell(ARCANEBRILLIANCE)

	#/arcane_brilliance
	unless BuffPresent(MAGEBUFF) Spell(ARCANEBRILLIANCE)
	#/scorch,debuff=1
	if TalentPoints(CRITICALMASSTALENT more 0) and TargetDebuffExpires(magicalcrittaken 6)
	{
		unless InCombat() Spell(PYROBLAST)
		if BuffPresent(HOTSTREAK) Spell(PYROBLAST)
		Spell(SCORCH)
	}
	#/living_bomb,if=!ticking
	if TargetDebuffExpires(LIVINGBOMB 0 mine=1) and TargetDeadIn(more 12) Spell(LIVINGBOMB)
	#/pyroblast_hs,if=buff.hot_streak.react
	if BuffPresent(HOTSTREAK) Spell(PYROBLAST)
	if TalentPoints(FIRESTARTERTALENT more 0) and Speed(more 0) Spell(SCORCH)
	#if ( glyphs.frostfire -> ok() ) { /frostfire_bolt }
	if Glyph(GLYPHOFFROSTFIRE) Spell(FROSTFIREBOLT usable=1)
	#/fireball
	Spell(FIREBALL usable=1)
	#/scorch
	Spell(SCORCH)
}

AddIcon help=cd mastery=2
{
	#/volcanic_potion,if=!in_combat
	if CheckBoxOn(potions) unless InCombat() Item(VOLCANICPOTION)
	if TargetBuffStealable() Spell(SPELLSTEAL)
	#/counterspell
	if TargetIsInterruptible() Spell(COUNTERSPELL)
	#/volcanic_potion,if=buff.bloodlust.react|target.time_to_die<=40
	if CheckBoxOn(potions) and {BuffPresent(heroism) or TargetDeadIn(less 40)} Item(VOLCANICPOTION)
	#/use_item
	UseItemActions()
	#init_use_profession_actions()
	UseProfessionActions()
	#/berserking
	Spell(BERSERKING)
	#/blood_fury
	Spell(BLOODFURY)
	#/combustion,if=dot.living_bomb.ticking&dot.ignite.ticking&dot.pyroblast.ticking&dot.ignite.tick_dmg>10000
	if TargetDebuffPresent(LIVINGBOMB mine=1) and TargetDebuffPresent(IGNITE mine=1)
		and {TargetDebuffPresent(PYROBLAST mine=1) or TargetDebuffPresent(PYROBLASTBANG mine=1)}
		and LastSpellDamage(IGNITE more 10000)
	{
		if CheckBoxOff(stolentime) or ArmorSetParts(T13 less 4) Spell(COMBUSTION)
		if CheckBoxOn(stolentime) and ArmorSetParts(T13 more 3) and BuffPresent(STOLENTIME stacks=8) Spell(COMBUSTION)
	}
	#/mirror_image,if=target.time_to_die>=25
	if CheckBoxOn(mirrorimage) and TargetDeadIn(more 24) Spell(MIRRORIMAGE)
	#/flame_orb,if=target.time_to_die>=12
	if TargetDeadIn(more 11) Spell(FLAMEORB)
}

AddIcon help=mana mastery=2
{
	unless InCombat() if BuffExpires(MAGEARMOR 400) and BuffExpires(MOLTENARMOR 400) and BuffExpires(FROSTARMOR 400) Spell(MOLTENARMOR)

	#/molten_armor,if=buff.mage_armor.down&buff.molten_armor.down
	unless BuffPresent(MAGEARMOR) or BuffPresent(MOLTENARMOR) or BuffPresent(FROSTARMOR) Spell(MOLTENARMOR)
	#/molten_armor,if=mana_pct>45&buff.mage_armor.up
	if BuffPresent(MAGEARMOR) and ManaPercent(more 45) Spell(MOLTENARMOR)
	#/conjure_mana_gem,invulnerable=1,if=mana_gem_charges<3
	unless InCombat() if ItemCount(MANAGEMITEM less 3 charges=1) Spell(CONJUREMANAGEM)

	# If we can't use Scorch as a filler, then use Evocation like other mage specs.
	# /evocation,if=mana_pct<40&buff.bloodlust.react
	if TalentPoints(FIRESTARTERTALENT less 1) and ManaPercent(less 40) and BuffExpires(heroism 1.5) Spell(EVOCATION)

	#/arcane_torrent,if=mana_pct<91
	if ManaPercent(less 91) Spell(ARCANETORRENTMANA)
	#/mana_gem,if=mana_deficit>12500
	if player.maxMana() - player.mana() > 12500 Item(MANAGEMITEM)
	#/mage_armor,if=mana_pct<5&buff.mage_armor.down
	if BuffExpires(MAGEARMOR 0) and ManaPercent(less 5) Spell(MAGEARMOR)
}

###
### Frost
###
AddIcon help=main mastery=3
{
	unless InCombat() if BuffExpires(MAGEBUFF 400) Spell(ARCANEBRILLIANCE)

	#/arcane_brilliance
	unless BuffPresent(MAGEBUFF) Spell(ARCANEBRILLIANCE)
	#/water_elemental
	if PetPresent(no) Spell(SUMMONWATERELEMENTAL)
	if TalentPoints(DEEPFREEZETALENT more 0) and 1s before Spell(DEEPFREEZE)
		unless BuffPresent(FINGERSOFFROST) Spell(PETFREEZE)

	#/deep_freeze,if=buff.fingers_of_frost.react
	Spell(DEEPFREEZE usable=1)
	#/frostfire_bolt,if=buff.brain_freeze.react&buff.fingers_of_frost.react
	if BuffPresent(BRAINFREEZE) and BuffPresent(FINGERSOFFROST)
	{
		Spell(FROSTFIREBOLT)
		Spell(FIREBALL)
	}
	#/ice_lance,if=buff.fingers_of_frost.stack>1
	if BuffPresent(FINGERSOFFROST stacks=2) Spell(ICELANCE)
	#/ice_lance,if=buff.fingers_of_frost.react&pet.water_elemental.cooldown.freeze.remains<gcd
	if BuffPresent(FINGERSOFFROST) and {spell(PETFREEZE) < timeWithHaste(1.5)} Spell(ICELANCE)
	if Speed(more 0)
	{
		#/ice_lance,moving=1
		Spell(ICELANCE)
		#/fire_blast,moving=1
		Spell(FIREBLAST)
	}
	#/frostbolt
	if CastTime(FROSTFIREBOLT less 1.251) Spell(FROSTFIREBOLT)
	Spell(FROSTBOLT)
}

AddIcon help=cd mastery=3
{
	#/volcanic_potion,if=!in_combat
	if CheckBoxOn(potions) unless InCombat() Item(VOLCANICPOTION)
	if TargetBuffStealable() Spell(SPELLSTEAL)
	#/counterspell
	if TargetIsInterruptible() Spell(COUNTERSPELL)
	#/use_item
	UseItemActions()
	#init_use_profession_actions()
	UseProfessionActions()
	#/volcanic_potion,if=buff.bloodlust.react|buff.icy_veins.react|target.time_to_die<=40
	if CheckBoxOn(potions) and {BuffPresent(heroism) or BuffPresent(ICYVEINS) or TargetDeadIn(less 40)} Item(VOLCANICPOTION)
	#/blood_fury
	Spell(BLOODFURY)
	#/cold_snap,if=cooldown.deep_freeze.remains>15&cooldown.frostfire_orb.remains>30&cooldown.icy_veins.remains>30
	unless {TalentPoints(DEEPFREEZETALENT more 0) and 15s before Spell(DEEPFREEZE)} or 30s before Spell(FLAMEORB)
		or {TalentPoints(ICYVEINSTALENT more 0) and 30s before Spell(ICYVEINS)}
		Spell(COLDSNAP)
	#/frostfire_orb,if=target.time_to_die>=12&!ticking
	if TargetDeadIn(more 12)
	{
		if TalentPoints(COLDSNAPTALENT more 0)
		{
			if TalentPoints(ICEFLOESTALENT equal 3) and 369s before Spell(COLDSNAP) Spell(FLAMEORB)
			if TalentPoints(ICEFLOESTALENT equal 2) and 398s before Spell(COLDSNAP) Spell(FLAMEORB)
			if TalentPoints(ICEFLOESTALENT equal 1) and 432s before Spell(COLDSNAP) Spell(FLAMEORB)
			if TalentPoints(ICEFLOESTALENT equal 0) and 465s before Spell(COLDSNAP) Spell(FLAMEORB)
		}
		unless TalentPoints(COLDSNAPTALENT more 0) Spell(FLAMEORB)
	}
	#/mirror_image,if=target.time_to_die>=25
	if CheckBoxOn(mirrorimage) and TargetDeadIn(more 25) Spell(MIRRORIMAGE)
	unless BuffPresent(ICYVEINS) or BuffPresent(heroism)
	{
		#/berserking,if=buff.icy_veins.down&buff.bloodlust.down
		Spell(BERSERKING)
		#/icy_veins,if=buff.icy_veins.down&buff.bloodlust.down
		unless ArmorSetParts(T13 more 3) Spell(ICYVEINS)
		#/icy_veins,if=buff.icy_veins.down&buff.bloodlust.down&(buff.tier13_2pc.stack>7|cooldown.cold_snap.remains<22)
		if ArmorSetParts(T13 more 3) and {BuffPresent(STOLENTIME stacks=8) or 22s before Spell(COLDSNAP)} Spell(ICYVEINS)
	}
}

AddIcon help=mana mastery=3
{
	unless InCombat() if BuffExpires(MAGEARMOR 400) and BuffExpires(MOLTENARMOR 400) and BuffExpires(FROSTARMOR 400) Spell(MOLTENARMOR)

	#/conjure_mana_gem,invulnerable=1,if=mana_gem_charges<3
	unless InCombat() if ItemCount(MANAGEMITEM less 3 charges=1) Spell(CONJUREMANAGEM)
	#/molten_armor
	unless BuffPresent(MAGEARMOR) or BuffPresent(MOLTENARMOR) or BuffPresent(FROSTARMOR) Spell(MOLTENARMOR)
	#/arcane_torrent,if=mana_pct<91
	if ManaPercent(less 91) Spell(ARCANETORRENTMANA)
	#/evocation,if=mana_pct<40&(buff.icy_veins.react|buff.bloodlust.react)
	if ItemCount(MANAGEMITEM equal 0 charges=1) and {BuffExpires(heroism 1.5) or BuffExpires(ICYVEINS 1.5)} Spell(CONJUREMANAGEM)
	if ManaPercent(less 40) and {BuffExpires(heroism 1.5) or BuffExpires(ICYVEINS 1.5)} Spell(EVOCATION)
	#/mana_gem,if=mana_deficit>12500
	if player.maxMana() - player.mana() > 12500 Item(MANAGEMITEM)
}